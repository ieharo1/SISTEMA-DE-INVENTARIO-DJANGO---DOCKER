{% extends 'base.html' %}

{% block title %}Dashboard - {{ company_name }}{% endblock %}

{% block breadcrumbs %}
<nav aria-label="breadcrumb" class="mb-3">
  <ol class="breadcrumb panel p-2 px-3 mb-0">
    <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Inicio</a></li>
    <li class="breadcrumb-item active" aria-current="page">Dashboard</li>
  </ol>
</nav>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="h3 mb-1"><i class="bi bi-speedometer2"></i> Dashboard Ejecutivo</h1>
    <p class="text-muted mb-0">Resumen comercial y operativo</p>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-primary btn-sm" href="{% url 'products:product_create' %}"><i class="bi bi-plus-circle"></i> Nuevo producto</a>
    <a class="btn btn-outline-primary btn-sm" href="{% url 'movements:movement_create' 'IN' %}"><i class="bi bi-box-arrow-in-down"></i> Registrar entrada</a>
  </div>
</div>

<div class="row g-3 mb-4">
  <div class="col-md-6 col-xl-3"><div class="card"><div class="card-body"><div class="text-muted small">Total productos</div><div class="display-6 fw-semibold">{{ total_products|default:'0' }}</div></div></div></div>
  <div class="col-md-6 col-xl-3"><div class="card"><div class="card-body"><div class="text-muted small">Total categorias</div><div class="display-6 fw-semibold">{{ total_categories|default:'0' }}</div></div></div></div>
  <div class="col-md-6 col-xl-3"><div class="card"><div class="card-body"><div class="text-muted small">Stock bajo</div><div class="display-6 fw-semibold text-warning">{{ low_stock_count|default:'0' }}</div></div></div></div>
  <div class="col-md-6 col-xl-3"><div class="card"><div class="card-body"><div class="text-muted small">Total proveedores</div><div class="display-6 fw-semibold">{{ total_suppliers|default:'0' }}</div></div></div></div>
</div>

<div class="row g-3">
  <div class="col-xl-7">
    <div class="card h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <strong>Ultimos movimientos</strong>
        <a class="btn btn-sm btn-outline-secondary" href="{% url 'movements:movement_list' %}">Ver todos</a>
      </div>
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead><tr><th>Tipo</th><th>Producto</th><th>Cantidad</th><th>Fecha</th></tr></thead>
          <tbody>
            {% for movement in recent_movements %}
            <tr>
              <td>{% if movement.movement_type == 'IN' %}<span class="badge bg-success">Entrada</span>{% elif movement.movement_type == 'OUT' %}<span class="badge bg-danger">Salida</span>{% else %}<span class="badge bg-info">{{ movement.get_movement_type_display }}</span>{% endif %}</td>
              <td>{{ movement.product.name|truncatechars:28 }}</td>
              <td>{{ movement.quantity }}</td>
              <td>{{ movement.created_at|date:'d/m/Y H:i' }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="4" class="text-center text-muted py-4">No hay movimientos recientes.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="col-xl-5">
    <div class="card h-100">
      <div class="card-header"><strong>Stock por bodega</strong></div>
      <div class="card-body"><canvas id="stockChart" height="170"></canvas></div>
    </div>
  </div>
</div>

<div class="row g-3 mt-1">
  <div class="col-12">
    <div class="card">
      <div class="card-header"><strong>Productos con stock bajo</strong></div>
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead><tr><th>Producto</th><th>Stock actual</th><th>Stock minimo</th></tr></thead>
          <tbody>
            {% for item in low_stock_products %}
            <tr><td>{{ item.product.name }}</td><td><span class="badge bg-danger">{{ item.quantity }}</span></td><td>{{ item.min_stock }}</td></tr>
            {% empty %}
            <tr><td colspan="3" class="text-center text-muted py-4">Sin alertas de stock bajo.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  (function() {
    const labels = [{% for row in stock_by_warehouse %}'{{ row.warehouse__name|escapejs }}'{% if not forloop.last %}, {% endif %}{% endfor %}];
    const data = [{% for row in stock_by_warehouse %}{{ row.total|default:0 }}{% if not forloop.last %}, {% endif %}{% endfor %}];
    const ctx = document.getElementById('stockChart');
    if (!ctx) return;
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'Stock total',
          data,
          borderRadius: 8,
          backgroundColor: 'rgba(59,130,246,.8)'
        }]
      },
      options: {
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
      }
    });
  })();
</script>
{% endblock %}
